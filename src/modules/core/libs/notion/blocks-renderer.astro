---
import Code from "./blocks/code.astro";
import Embed from "./blocks/embed.astro";
import Heading from "./blocks/heading.astro";
import Image from "./blocks/image.astro";
import List from "./blocks/list.astro";
import ListItem from "./blocks/list-item.astro";
import Paragraph from "./blocks/paragraph.astro";
import Quote from "./blocks/quote.astro";
import BlocksRendererRecursive from "./blocks-renderer.astro";
import type { BlockWithChildren } from "./types";

interface Props {
  blocks: BlockWithChildren[];
  imageBasePath: string;
  imageIdPrefix?: string;
  imageIndex?: number;
}

const { blocks, imageBasePath, imageIdPrefix, imageIndex: startImageIndex = 0 } = Astro.props;

// Count images before a specific index (including nested images)
function countImagesBeforeIndex(blocks: BlockWithChildren[], targetIndex: number): number {
  let count = 0;
  for (let i = 0; i < targetIndex; i++) {
    const { block, children } = blocks[i];
    if ("type" in block && block.type === "image") {
      count++;
    }
    if (children && children.length > 0) {
      count += countAllImages(children);
    }
  }
  return count;
}

function countAllImages(blocks: BlockWithChildren[]): number {
  let count = 0;
  for (const { block, children } of blocks) {
    if ("type" in block && block.type === "image") {
      count++;
    }
    if (children && children.length > 0) {
      count += countAllImages(children);
    }
  }
  return count;
}
---

{blocks.map(({ block, children }, index) => {
  if (!("type" in block)) {
    return null;
  }

  const previousBlockType =
    index > 0 && "type" in blocks[index - 1].block
      ? blocks[index - 1].block.type
      : null;

  // Calculate image index for projects
  let currentImageIndex: number | undefined = undefined;
  if (block.type === "image" && imageIdPrefix) {
    const imagesBefore = countImagesBeforeIndex(blocks, index);
    currentImageIndex = startImageIndex + imagesBefore + 1;
  }

  switch (block.type) {
    case "paragraph":
      return (
        <Paragraph
          block={block}
          children={children || undefined}
          previousBlockType={previousBlockType}
          imageBasePath={imageBasePath}
          imageIdPrefix={imageIdPrefix}
          renderChildren={BlocksRendererRecursive}
        />
      );

    case "heading_1":
    case "heading_2":
    case "heading_3":
      return (
        <Heading
          block={block}
          children={children || undefined}
          imageBasePath={imageBasePath}
          imageIdPrefix={imageIdPrefix}
          renderChildren={BlocksRendererRecursive}
        />
      );

    case "bulleted_list":
    case "numbered_list":
      return (
        <List
          block={block}
          children={children || undefined}
          imageBasePath={imageBasePath}
          imageIdPrefix={imageIdPrefix}
          renderChildren={BlocksRendererRecursive}
        />
      );

    case "bulleted_list_item":
    case "numbered_list_item":
      return (
        <ListItem
          block={block}
          children={children || undefined}
          imageBasePath={imageBasePath}
          imageIdPrefix={imageIdPrefix}
          renderChildren={BlocksRendererRecursive}
        />
      );

    case "image":
      return (
        <Image
          block={block}
          imageBasePath={imageBasePath}
          imageIdPrefix={imageIdPrefix}
          imageIndex={currentImageIndex}
        />
      );

    case "code":
      return <Code block={block} />;

    case "quote":
      return (
        <Quote
          block={block}
          children={children || undefined}
          imageBasePath={imageBasePath}
          imageIdPrefix={imageIdPrefix}
          renderChildren={BlocksRendererRecursive}
        />
      );

    case "embed":
      return <Embed block={block} />;

    default:
      // Unsupported block types are silently ignored
      return null;
  }
})}

