---
import ArticleDetailsPage from "../../modules/article/pages/article-details-page.astro";
import {
  getArticleDetailAndNavigationBySlug,
  getNotionArticleDataBySlug,
} from "../../modules/article/services/article-service";
import { transformBlocksToContent } from "../../modules/article/utils/article-content-utils";

export async function getStaticPaths() {
  const { getArticles } = await import("../../modules/article/services/article-service");
  const articles = await getArticles();

  return articles.map((article) => ({
    params: { slug: article.slug },
  }));
}

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect("/articles");
}

// Get article detail with navigation
const { article, previousArticle, nextArticle } = await getArticleDetailAndNavigationBySlug(slug);

if (!article) {
  return Astro.redirect("/articles");
}

// Get raw Notion data for blocks transformation
const notionArticleData = await getNotionArticleDataBySlug(slug);

if (!notionArticleData) {
  return Astro.redirect("/articles");
}

// Transform blocks to content items
const content = transformBlocksToContent(notionArticleData.blocks);

// Get categories from article
const categories = article.categories || [];
---

<ArticleDetailsPage
  title={article.title}
  date={article.date}
  minsRead={article.minsRead}
  content={content}
  categories={categories}
  previousArticle={previousArticle ? { title: previousArticle.title, slug: previousArticle.slug } : undefined}
  nextArticle={nextArticle ? { title: nextArticle.title, slug: nextArticle.slug } : undefined}
/>

